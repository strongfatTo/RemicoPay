<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PayFlow • Logged-in Dashboard</title>
    <meta name="supabase-url" content="https://wgzrajebtwsjruhcefdq.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnenJhamVidHdzanJ1aGNlZmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTI3ODYsImV4cCI6MjA3OTU2ODc4Nn0.TJooqLjsyTL1aNO65KHce46eI4eiCSJlpS0VWyQeaG8">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-geist { font-family: 'Geist', sans-serif !important; }
        .font-bricolage { font-family: 'Bricolage Grotesque', sans-serif !important; }

        @keyframes fade-slide {
            0% { opacity: 0; transform: translateY(24px) scale(.96); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .fade-slide { animation: fade-slide .7s both; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        select option {
            background-color: white;
            color: #1f2937;
        }

        .flow-pill {
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 1rem;
            padding: 0.9rem 1rem;
            background: rgba(15, 23, 42, 0.5);
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            transition: border-color 0.2s ease, background 0.2s ease;
        }
        .flow-pill span {
            width: 1.8rem;
            height: 1.8rem;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .flow-pill p {
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .flow-pill.active {
            border-color: rgba(79, 70, 229, 0.6);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.2));
        }
        .flow-pill.completed {
            border-color: rgba(16, 185, 129, 0.7);
            color: #a7f3d0;
        }
    </style>
    
    <!-- Initialize global state and functions BEFORE module script -->
    <script>
        // Display username from localStorage
        (function() {
            const userFullName = localStorage.getItem('userFullName');
            if (userFullName) {
                const greetName = document.getElementById('greetName');
                if (greetName) {
                    greetName.textContent = userFullName;
                }
            }
        })();
        
        // Global state for send money flow
        window.selectedRecipientId = null;
        window.currentAmount = 0;
        window.countdownInterval = null;
        
        // Recipients data
        window.recipients = [
            { id: 'rcp-maria', name: 'Maria Santos', country: 'PH', bank: 'BDO Unibank', account: '1234567890', avatar: 'M', accent: 'blue' },
            { id: 'rcp-somchai', name: 'Somchai Wong', country: 'TH', bank: 'Bangkok Bank', account: '9876543210', avatar: 'S', accent: 'emerald' },
            { id: 'rcp-rina', name: 'Rina Wijaya', country: 'ID', bank: 'Bank Mandiri', account: '4321098765', avatar: 'R', accent: 'purple' },
            { id: 'rcp-liwei', name: 'Li Wei', country: 'VN', bank: 'Vietcombank', account: '8899776655', avatar: 'L', accent: 'amber' }
        ];
        
        window.countryLabels = { 'PH': 'Philippines', 'TH': 'Thailand', 'ID': 'Indonesia', 'VN': 'Vietnam' };
        
        // Helper functions
        window.maskAccount = function(account = '') {
            if (!account) return '****';
            if (account.startsWith('****')) return account;
            return `****${account.slice(-4)}`;
        };
        
        window.getSelectedRecipient = function() {
            return window.recipients.find(r => r.id === window.selectedRecipientId);
        };
        
        window.selectRecipient = function(recipientId) {
            window.selectedRecipientId = recipientId;
            window.updateStepControls();
        };
        
        window.addNewRecipient = function(name, country, bank, account) {
            const newRecipient = {
                id: 'rcp-' + Date.now(),
                name: name,
                country: country,
                bank: bank,
                account: account,
                avatar: name.charAt(0).toUpperCase(),
                accent: ['blue', 'emerald', 'purple', 'amber'][Math.floor(Math.random() * 4)]
            };
            window.recipients.push(newRecipient);
            window.renderModalRecipients();
            return newRecipient;
        };
        
        window.renderModalRecipients = function() {
            const modalRecipientList = document.getElementById('modalRecipientList');
            if (!modalRecipientList) return;
            
            modalRecipientList.innerHTML = window.recipients.map((recipient) => {
                const isSelected = recipient.id === window.selectedRecipientId;
                return `
                    <button type="button" data-recipient-option="${recipient.id}" class="rounded-2xl border ${isSelected ? 'border-blue-400 ring-2 ring-blue-400/60' : 'border-white/10'} bg-white/5 p-4 text-left transition hover:border-white/40">
                        <div class="flex items-center justify-between mb-3">
                            <div class="h-10 w-10 rounded-full bg-blue-500/30 flex items-center justify-center text-blue-200 font-semibold">${recipient.avatar}</div>
                            ${isSelected ? '<i data-lucide="check-circle-2" class="h-5 w-5 text-blue-400"></i>' : ''}
                        </div>
                        <p class="text-white font-semibold">${recipient.name}</p>
                        <p class="text-xs text-gray-400">${recipient.bank} • ${window.maskAccount(recipient.account)}</p>
                    </button>
                `;
            }).join('');
            
            modalRecipientList.querySelectorAll('[data-recipient-option]')?.forEach(card => {
                card.addEventListener('click', () => {
                    const recipientId = card.getAttribute('data-recipient-option');
                    window.selectRecipient(recipientId);
                    window.renderModalRecipients();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };
        
        window.updateStepControls = function() {
            const toStep2 = document.getElementById('toStep2');
            const toStep3 = document.getElementById('toStep3');
            const hasRecipient = !!window.selectedRecipientId;
            const hasAmount = window.currentAmount > 0;
            if (toStep2) toStep2.toggleAttribute('disabled', !hasRecipient);
            if (toStep3) toStep3.toggleAttribute('disabled', !hasAmount);
        };
        
        window.updateAmountPreviews = function() {
            const sendAmountInput = document.getElementById('sendAmountInput');
            const feePreview = document.getElementById('feePreview');
            const receiveAmountPreview = document.getElementById('receiveAmountPreview');
            const reviewSend = document.getElementById('reviewSend');
            const reviewFee = document.getElementById('reviewFee');
            const reviewReceive = document.getElementById('reviewReceive');
            
            const rawValue = parseFloat(sendAmountInput?.value || '0');
            window.currentAmount = Number.isFinite(rawValue) && rawValue > 0 ? rawValue : 0;
            const fee = window.currentAmount ? Math.max(window.currentAmount * 0.008, 8).toFixed(2) : '0.00';
            const php = window.currentAmount ? (window.currentAmount * 6.5).toFixed(2) : '0.00';
            
            if (feePreview) feePreview.textContent = fee;
            if (receiveAmountPreview) receiveAmountPreview.textContent = `PHP ${php}`;
            if (reviewSend) reviewSend.textContent = `HKD ${window.currentAmount.toFixed(2)}`;
            if (reviewFee) reviewFee.textContent = fee;
            if (reviewReceive) reviewReceive.textContent = `PHP ${php}`;
            window.updateStepControls();
        };
        
        // Flow step navigation
        window.showFlowStep = function(index) {
            const flowSteps = ['flowStep1','flowStep2','flowStep3','flowStep4'].map(id => document.getElementById(id));
            const flowPills = Array.from(document.querySelectorAll('#sendFlowProgress .flow-pill'));
            
            flowSteps.forEach((step, i) => {
                if (!step) return;
                if (i === index) step.classList.remove('hidden');
                else step.classList.add('hidden');
            });
            
            flowPills.forEach((pill, i) => {
                pill.classList.toggle('active', i === index);
                pill.classList.toggle('completed', i < index);
            });
            
            if (index !== 3) {
                window.resetCountdown();
            }
        };
        
        window.resetCountdown = function() {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
            const fpsCountdown = document.getElementById('fpsCountdown');
            if (fpsCountdown) fpsCountdown.textContent = '15:00';
        };
        
        window.startCountdown = function() {
            window.resetCountdown();
            let remaining = 15 * 60;
            window.countdownInterval = setInterval(() => {
                remaining -= 1;
                if (remaining <= 0) {
                    window.resetCountdown();
                    return;
                }
                const minutes = String(Math.floor(remaining / 60)).padStart(2, '0');
                const seconds = String(remaining % 60).padStart(2, '0');
                const fpsCountdown = document.getElementById('fpsCountdown');
                if (fpsCountdown) fpsCountdown.textContent = `${minutes}:${seconds}`;
            }, 1000);
        };
        
        window.resetSendMoneyFlow = function() {
            window.selectedRecipientId = null;
            window.currentAmount = 0;
            const sendAmountInput = document.getElementById('sendAmountInput');
            if (sendAmountInput) sendAmountInput.value = '';
            
            const feePreview = document.getElementById('feePreview');
            const receiveAmountPreview = document.getElementById('receiveAmountPreview');
            const reviewSend = document.getElementById('reviewSend');
            const reviewFee = document.getElementById('reviewFee');
            const reviewReceive = document.getElementById('reviewReceive');
            const reviewRecipientName = document.getElementById('reviewRecipientName');
            const reviewRecipientBank = document.getElementById('reviewRecipientBank');
            const fpsRecipient = document.getElementById('fpsRecipient');
            const fpsBank = document.getElementById('fpsBank');
            const fpsReference = document.getElementById('fpsReference');
            const fpsExactAmount = document.getElementById('fpsExactAmount');
            
            if (feePreview) feePreview.textContent = '0.00';
            if (receiveAmountPreview) receiveAmountPreview.textContent = 'PHP 0.00';
            if (reviewSend) reviewSend.textContent = 'HKD 0';
            if (reviewFee) reviewFee.textContent = '0';
            if (reviewReceive) reviewReceive.textContent = 'PHP 0';
            if (reviewRecipientName) reviewRecipientName.textContent = '-';
            if (reviewRecipientBank) reviewRecipientBank.textContent = '-';
            if (fpsRecipient) fpsRecipient.textContent = '-';
            if (fpsBank) fpsBank.textContent = '-';
            if (fpsReference) fpsReference.textContent = 'TX0000000000';
            if (fpsExactAmount) fpsExactAmount.textContent = 'HKD 0.00';
            
            window.renderModalRecipients();
            window.showFlowStep(0);
            window.updateStepControls();
        };
        
        window.populateReviewRecipient = function() {
            const recipient = window.getSelectedRecipient();
            if (!recipient) return;
            const reviewRecipientName = document.getElementById('reviewRecipientName');
            const reviewRecipientBank = document.getElementById('reviewRecipientBank');
            if (reviewRecipientName) reviewRecipientName.textContent = recipient.name;
            if (reviewRecipientBank) reviewRecipientBank.textContent = `${recipient.bank} • ${window.maskAccount(recipient.account)}`;
        };
        
        window.populateFpsSection = function() {
            const recipient = window.getSelectedRecipient();
            if (!recipient) return;
            const php = (window.currentAmount * 6.5).toFixed(2);
            const txId = `TX${Date.now()}`;
            
            const fpsRecipient = document.getElementById('fpsRecipient');
            const fpsBank = document.getElementById('fpsBank');
            const fpsReference = document.getElementById('fpsReference');
            const fpsExactAmount = document.getElementById('fpsExactAmount');
            const feePreview = document.getElementById('feePreview');
            
            if (fpsRecipient) fpsRecipient.textContent = recipient.name;
            if (fpsBank) fpsBank.textContent = `${recipient.bank} (${window.countryLabels[recipient.country] || recipient.country})`;
            if (fpsReference) fpsReference.textContent = txId;
            if (fpsExactAmount) fpsExactAmount.textContent = `HKD ${(window.currentAmount + parseFloat(feePreview?.textContent || '0')).toFixed(2)}`;
            
            const fpsFinalPhp = document.getElementById('fpsFinalPhp');
            if (fpsFinalPhp) fpsFinalPhp.textContent = `PHP ${php}`;
        };
        
        window.signOut = function() {
            // Clear localStorage to remove session data
            localStorage.removeItem('userFullName');
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('sb-wgzrajebtwsjruhcefdq-auth-token');
            // Clear all localStorage items that might contain session data
            Object.keys(localStorage).forEach(key => {
                if (key.includes('supabase') || key.includes('auth')) {
                    localStorage.removeItem(key);
                }
            });
            // Redirect to index
            window.location.href = 'index.html';
        };
    </script>
</head>

<body class="bg-slate-950 text-gray-100 min-h-screen overflow-x-hidden">
    <!-- Background -->
    <div class="fixed inset-0 -z-10 opacity-70 pointer-events-none">
        <iframe src="https://my.spline.design/glasswave-6HLEnvJfCRsq1aKT2xqlgme7" frameborder="0" width="100%" height="100%" class="w-full h-full"></iframe>
    </div>

    <!-- Navigation -->
    <header class="fixed left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] sm:w-[calc(100%-3rem)] lg:w-[calc(100%-4rem)] max-w-7xl top-0 sm:top-4 lg:top-6 z-50 flex sm:px-6 lg:px-8 ring-1 ring-white/10 shadow-black/20 bg-slate-900/80 border-white/10 border rounded-2xl pt-4 pr-4 pb-4 pl-4 shadow-lg backdrop-blur-xl items-center justify-between">
        <div class="w-full max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="flex flex-col">
                    <span class="text-lg font-bold tracking-tight text-white font-geist">FPS-Stable</span>
                    <span class="text-xs text-gray-300 font-medium font-geist">Cross-Border Rail</span>
                </div>
                <span id="userBadge" class="hidden md:inline-flex items-center text-xs text-emerald-200 bg-emerald-500/10 border border-emerald-400/20 px-3 py-1 rounded-lg font-geist">Logged in</span>
            </div>

            <nav class="hidden lg:flex items-center space-x-2" aria-label="Primary">
                <a href="#" class="flex items-center space-x-2 px-4 py-2 text-sm rounded-lg hover:bg-white/10 hover:ring-1 hover:ring-white/15 transition text-gray-200">
                    <i data-lucide="layout-dashboard" class="h-4 w-4"></i><span class="font-geist">Overview</span>
                </a>
            </nav>

            <div class="hidden sm:flex items-center space-x-3">
                <button id="headerNewTransfer" class="flex items-center space-x-2 px-4 py-2 text-sm rounded-lg bg-gradient-to-r from-blue-400 to-emerald-400 text-white shadow-lg shadow-blue-900/30 hover:-translate-y-0.5 transition">
                    <i data-lucide="plus" class="h-4 w-4"></i>
                    <span class="font-geist">New Transfer</span>
                </button>
                <div class="flex items-center space-x-2 border border-white/10 rounded-xl px-3 py-1.5">
                    <div id="userAvatar" class="h-8 w-8 rounded-full bg-white/10 flex items-center justify-center text-sm font-semibold">U</div>
                    <div class="hidden md:block">
                        <p id="userNameLabel" class="text-sm text-white font-geist">User</p>
                    </div>
                </div>
                <button id="signOutBtn" class="flex items-center space-x-2 px-4 py-2 text-sm rounded-lg border border-white/15 bg-white/5 text-gray-100 hover:bg-white/10 transition">
                    <i data-lucide="log-out" class="h-4 w-4"></i>
                    <span class="font-geist">Sign out</span>
                </button>
            </div>

            <button id="mobileToggle" class="relative z-30 flex h-10 w-10 items-center justify-center rounded-lg border border-white/15 bg-white/10 text-white sm:hidden hover:bg-white/15" aria-expanded="false">
                <i data-lucide="menu" class="h-5 w-5"></i>
            </button>
        </div>
    </header>

    <nav id="mobileNav" aria-label="Mobile" class="absolute inset-x-0 top-0 z-40 hidden flex-col space-y-2 bg-slate-900/95 px-4 pb-8 pt-24 backdrop-blur-xl border-b border-white/10 sm:hidden">
        <a href="#" class="flex items-center space-x-3 rounded-lg px-4 py-3 text-gray-100 hover:bg-white/10 transition"><i data-lucide="layout-dashboard" class="h-5 w-5"></i><span class="font-geist">Overview</span></a>
        <button id="mobileSignOutBtn" class="flex items-center justify-center gap-2 rounded-lg border border-white/15 bg-white/5 px-4 py-3 text-gray-100 hover:bg-white/10 transition mt-2">
            <i data-lucide="log-out" class="h-5 w-5"></i>
            <span class="font-geist">Sign out</span>
        </button>
    </nav>

    <!-- Main -->
    <main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-20 space-y-12">
        <!-- Welcome -->
        <section class="fade-slide rounded-3xl border border-white/10 bg-white/5 p-6 sm:p-10 backdrop-blur-xl shadow-2xl">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-8">
                <div class="space-y-4">
                    <p class="inline-flex items-center gap-2 rounded-full border border-blue-400/20 bg-blue-400/10 px-3 py-1 text-xs text-blue-100 font-geist">
                        <span class="h-2 w-2 rounded-full bg-emerald-300 animate-pulse"></span>
                        Session active · FPS sandbox
                    </p>
                    <h1 class="text-4xl sm:text-5xl font-light text-white font-bricolage">Good morning, <span id="greetName" class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">User</span>!</h1>
                    <p class="text-lg text-gray-300 font-geist max-w-2xl">
                        You currently have 4 remittances in transit. All logins, KYC, and reminders are ready. The real-time KPIs below will tell you the next step.
                    </p>
                    <div class="flex flex-wrap gap-3">
                        <button id="summaryNewTransfer" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-blue-400 to-emerald-400 px-5 py-3 text-sm font-medium text-white shadow-lg shadow-blue-900/30">
                            <i data-lucide="send" class="h-4 w-4"></i> Initiate New Remittance
                        </button>
                        <button class="inline-flex items-center gap-2 rounded-xl border border-white/15 bg-white/5 px-5 py-3 text-sm font-medium text-gray-100 hover:bg-white/10">
                            <i data-lucide="calendar-clock" class="h-4 w-4"></i> View Schedule
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 min-w-[280px]">
                    <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-4">
                        <p class="text-xs text-emerald-200 font-geist uppercase tracking-widest">Settled This Month</p>
                        <p class="text-3xl text-white font-bricolage font-light mt-1">HKD 248K</p>
                        <p class="text-xs text-gray-300 mt-2">Compared to last month +18%</p>
                    </div>
                    <div class="rounded-2xl border border-purple-400/20 bg-purple-500/10 p-4">
                        <p class="text-xs text-purple-200 font-geist uppercase tracking-widest">Average Arrival</p>
                        <p class="text-3xl text-white font-bricolage font-light mt-1">12 min</p>
                        <p class="text-xs text-gray-300 mt-2">Target ≤15 minutes</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats -->
        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            <div class="rounded-2xl border border-blue-400/20 bg-gradient-to-br from-blue-900/20 to-black p-6 backdrop-blur-xl fade-slide" style="animation-delay:.05s">
                <div class="flex items-center justify-between">
                    <div class="h-10 w-10 rounded-xl bg-blue-500/15 flex items-center justify-center"><i data-lucide="wallet" class="text-blue-300 h-5 w-5"></i></div>
                    <span class="text-xs text-blue-200 bg-blue-500/15 px-2 py-1 rounded-lg font-geist">+12%</span>
                </div>
                <p class="text-sm text-gray-400 mt-4 font-geist">Monthly Accumulated Remittance</p>
                <p class="text-3xl text-white font-bricolage font-light">HKD 125,890</p>
                <p class="text-xs text-gray-400 mt-2">Monthly limit 500K</p>
            </div>
            <div class="rounded-2xl border border-emerald-400/20 bg-gradient-to-br from-emerald-900/20 to-black p-6 backdrop-blur-xl fade-slide" style="animation-delay:.1s">
                <div class="flex items-center justify-between">
                    <div class="h-10 w-10 rounded-xl bg-emerald-500/15 flex items-center justify-center"><i data-lucide="check-circle-2" class="text-emerald-300 h-5 w-5"></i></div>
                    <span class="text-xs text-emerald-200 bg-emerald-500/15 px-2 py-1 rounded-lg font-geist">47 transactions</span>
                </div>
                <p class="text-sm text-gray-400 mt-4 font-geist">Successful Transactions</p>
                <p class="text-3xl text-white font-bricolage font-light">98.4%</p>
                <p class="text-xs text-gray-400 mt-2">Automated reminders increased by 24%</p>
            </div>
            <div class="rounded-2xl border border-amber-400/20 bg-gradient-to-br from-amber-900/20 to-black p-6 backdrop-blur-xl fade-slide" style="animation-delay:.15s">
                <div class="flex items-center justify-between">
                    <div class="h-10 w-10 rounded-xl bg-amber-500/15 flex items-center justify-center"><i data-lucide="clock" class="text-amber-300 h-5 w-5"></i></div>
                    <span class="text-xs text-amber-200 font-geist">12m avg</span>
                </div>
                <p class="text-sm text-gray-400 mt-4 font-geist">Average Completion Time</p>
                <p class="text-3xl text-white font-bricolage font-light">-18%</p>
                <p class="text-xs text-gray-400 mt-2">FPS + Stablecoin pipeline</p>
            </div>
            <div class="rounded-2xl border border-purple-400/20 bg-gradient-to-br from-purple-900/20 to-black p-6 backdrop-blur-xl fade-slide" style="animation-delay:.2s">
                <div class="flex items-center justify-between">
                    <div class="h-10 w-10 rounded-xl bg-purple-500/15 flex items-center justify-center"><i data-lucide="shield" class="text-purple-300 h-5 w-5"></i></div>
                    <span class="text-xs text-purple-200 bg-purple-500/15 px-2 py-1 rounded-lg font-geist">Level 2</span>
                </div>
                <p class="text-sm text-gray-400 mt-4 font-geist">KYC / AML</p>
                <p class="text-3xl text-white font-bricolage font-light">100%</p>
                <p class="text-xs text-gray-400 mt-2">Audit passed, next level to be expanded</p>
            </div>
        </section>

        <!-- Quick Actions + Send Money -->
        <section class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2 rounded-3xl border border-white/10 bg-white/5 p-6 sm:p-8 backdrop-blur-xl fade-slide" style="animation-delay:.15s">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center">
                            <span class="text-white font-bold text-lg font-geist">$</span>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-[0.3em] text-blue-200 font-geist">Quick Actions</p>
                            <h2 class="text-2xl text-white font-bricolage font-light mt-2">What do you want to do next?</h2>
                        </div>
                    </div>
                </div>
                <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button id="sendMoneyBtn" class="rounded-2xl border border-blue-400/20 bg-blue-500/10 p-5 text-left hover:border-blue-400/40 transition">
                        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center mb-4">
                            <span class="text-white font-bold text-lg font-geist">$</span>
                        </div>
                        <p class="text-white font-semibold font-geist">Send Money</p>
                        <p class="text-xs text-gray-300 mt-1"><span id="recipientCountLabel">0</span> recipients ready</p>
                    </button>
                    <button id="addRecipientBtn" class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-5 text-left hover:border-emerald-400/40 transition">
                        <div class="h-10 w-10 rounded-xl bg-emerald-500/15 flex items-center justify-center mb-4"><i data-lucide="user-plus" class="text-emerald-300 h-5 w-5"></i></div>
                        <p class="text-white font-semibold font-geist">Add Recipient</p>
                        <p class="text-xs text-gray-300 mt-1">KYC lite in 60s</p>
                    </button>
                    <button id="downloadReceiptBtn" class="rounded-2xl border border-purple-400/20 bg-purple-500/10 p-5 text-left hover:border-purple-400/40 transition">
                        <div class="h-10 w-10 rounded-xl bg-purple-500/15 flex items-center justify-center mb-4"><i data-lucide="receipt" class="text-purple-300 h-5 w-5"></i></div>
                        <p class="text-white font-semibold font-geist">Download Receipt</p>
                        <p class="text-xs text-gray-300 mt-1">Latest 3 transactions ready</p>
                    </button>
                </div>
            </div>

            <div id="transferWorkflow" class="rounded-3xl border border-white/10 bg-white/5 p-6 backdrop-blur-xl fade-slide" style="animation-delay:.2s">
                <p class="text-xs uppercase tracking-[0.3em] text-emerald-200 font-geist">New Transfer</p>
                <h3 class="text-xl text-white font-semibold font-geist mt-2 mb-4">HKD 1,000 ➜ PH Bank</h3>
                <div class="space-y-4 text-sm text-gray-200 font-geist">
                    <div class="flex items-start gap-3 bg-white/5 border border-white/10 rounded-xl p-3">
                        <span class="h-8 w-8 flex items-center justify-center rounded-lg bg-blue-500/15 text-blue-200 font-semibold">1</span>
                        <p>User scans FPS QR code, enters recipient details, and transfers HKD 1,000 to our FPS account.</p>
                    </div>
                    <div class="flex items-start gap-3 bg-white/5 border border-white/10 rounded-xl p-3">
                        <span class="h-8 w-8 flex items-center justify-center rounded-lg bg-purple-500/15 text-purple-200 font-semibold">2</span>
                        <p>After receiving the funds, we purchase equivalent HKMA-compliant HKD stablecoin.</p>
                    </div>
                    <div class="flex items-start gap-3 bg-white/5 border border-white/10 rounded-xl p-3">
                        <span class="h-8 w-8 flex items-center justify-center rounded-lg bg-pink-500/15 text-pink-200 font-semibold">3</span>
                        <p>HKD stablecoin is instantly converted to PHPC, establishing cross-border liquidity.</p>
                    </div>
                    <div class="flex items-start gap-3 bg-white/5 border border-white/10 rounded-xl p-3">
                        <span class="h-8 w-8 flex items-center justify-center rounded-lg bg-amber-500/15 text-amber-200 font-semibold">4</span>
                        <p>In cooperation with authorized Philippine banks/exchanges, PHPC is converted to PHP and credited to the recipient bank.</p>
                    </div>
                    <div class="rounded-xl bg-gradient-to-br from-blue-900/20 to-black/40 border border-blue-400/20 p-4 text-xs text-gray-300">
                        Workflow is real-time synchronized; any node delay will trigger notifications and manual intervention.
                    </div>
                </div>
            </div>
        </section>

        <!-- Timeline + Transactions -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-3xl border border-white/10 bg-white/5 p-6 sm:p-8 backdrop-blur-xl fade-slide" style="animation-delay:.15s">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-amber-200 font-geist">Live Status</p>
                        <h2 class="text-2xl text-white font-bricolage font-light mt-2">Transaction Progress</h2>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="flex items-start gap-4">
                        <div class="relative">
                            <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/15 border border-emerald-400/30 text-emerald-200"><i data-lucide="check" class="h-4 w-4"></i></span>
                            <span class="absolute left-1/2 top-10 -translate-x-1/2 h-16 w-px bg-gradient-to-b from-emerald-400/40 to-transparent"></span>
                        </div>
                        <div>
                            <p class="text-sm text-white font-semibold font-geist">FPS Payment Completed</p>
                            <p class="text-xs text-gray-400">14:30 · Bank of China</p>
                            <p class="text-xs text-gray-300 mt-2">Email double-confirm sent to john@example.com</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <div class="relative">
                            <span class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-500/15 border border-blue-400/30 text-blue-200"><i data-lucide="refresh-ccw" class="h-4 w-4"></i></span>
                            <span class="absolute left-1/2 top-10 -translate-x-1/2 h-16 w-px bg-gradient-to-b from-blue-400/40 to-transparent"></span>
                        </div>
                        <div>
                            <p class="text-sm text-white font-semibold font-geist">HKD → Stablecoin</p>
                            <p class="text-xs text-gray-400">14:31 · Smart contract #221</p>
                            <p class="text-xs text-gray-300 mt-2">Deterministic FX 7.056, volatility monitoring normal.</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <div>
                            <span class="flex h-10 w-10 items-center justify-center rounded-full bg-purple-500/15 border border-purple-400/30 text-purple-200"><i data-lucide="send" class="h-4 w-4"></i></span>
                        </div>
                        <div>
                            <p class="text-sm text-white font-semibold font-geist">PH Disbursement</p>
                            <p class="text-xs text-gray-400">Waiting for BPI confirmation · SLA 15 min</p>
                            <p class="text-xs text-gray-300 mt-2">If overdue, Email + SMS will automatically remind.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rounded-3xl border border-white/10 bg-white/5 p-6 backdrop-blur-xl fade-slide" style="animation-delay:.2s">
                <p class="text-xs uppercase tracking-[0.3em] text-purple-200 font-geist">Recent Activity</p>
                <h3 class="text-xl text-white font-semibold font-geist mt-2 mb-4">Recent Three Transactions</h3>
                <div class="space-y-4">
                    <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white font-geist">TX20251029001</p>
                                <p class="text-xs text-gray-400">Maria Santos · PHP 35,250</p>
                            </div>
                            <span class="text-xs text-emerald-200 flex items-center gap-1"><i data-lucide="check-circle-2" class="h-3 w-3"></i>Completed</span>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white font-geist">TX20251028002</p>
                                <p class="text-xs text-gray-400">Somchai Wong · THB 15,925</p>
                            </div>
                            <span class="text-xs text-amber-200 flex items-center gap-1"><i data-lucide="loader" class="h-3 w-3 animate-spin"></i>Processing</span>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white font-geist">TX20251026004</p>
                                <p class="text-xs text-gray-400">Li Wei · CNY 1,820</p>
                            </div>
                            <span class="text-xs text-rose-200 flex items-center gap-1"><i data-lucide="alert-octagon" class="h-3 w-3"></i>Failed</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Reason: Receiving bank rejected, suggest resubmitting documents.</p>
                    </div>
                </div>
                <button class="w-full mt-5 text-sm text-blue-200 hover:text-white font-geist">View full history →</button>
            </div>
        </section>

        <!-- Recipients -->
        <section class="rounded-3xl border border-white/10 bg-white/5 p-6 sm:p-8 backdrop-blur-xl fade-slide" style="animation-delay:.2s">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-blue-200 font-geist">Recipients</p>
                    <h2 class="text-2xl text-white font-bricolage font-light">Frequent Recipients</h2>
                </div>
                <button id="recipientsAddNewBtn" class="inline-flex items-center gap-2 rounded-xl border border-white/15 bg-white/5 px-4 py-2 text-sm text-gray-100 hover:bg-white/10">
                    <i data-lucide="plus" class="h-4 w-4"></i> Add New
                </button>
            </div>
            <div id="recipientGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        </section>
    </main>

    <footer class="border-t border-white/10 py-8 text-center text-sm text-gray-400 font-geist">
        Logged in via Email · Google SSO available · © 2025 PayFlow Prototype
    </footer>

    <!-- Send Money Modal -->
    <div id="sendMoneyModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm px-4 py-10">
        <div class="relative w-full max-w-4xl rounded-3xl border border-white/10 bg-slate-950/95 p-8 shadow-2xl">
            <button id="closeSendMoney" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
            <div class="flex flex-col gap-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-[0.4em] text-blue-200 font-geist">Send money</p>
                        <h3 class="text-3xl text-white font-bricolage font-light">Simulate the full FPS ➜ Stablecoin ➜ PHP flow</h3>
                    </div>
                    <div class="hidden md:flex items-center gap-2 text-xs text-gray-400 font-geist">
                        <span class="flex items-center gap-1"><i data-lucide="clock" class="h-3.5 w-3.5"></i> Avg 12 min</span>
                        <span class="flex items-center gap-1"><i data-lucide="shield" class="h-3.5 w-3.5"></i> HKMA compliant</span>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3 text-xs font-geist" id="sendFlowProgress">
                    <div class="flow-pill active">
                        <span>1</span>
                        <p>Select recipient</p>
                    </div>
                    <div class="flow-pill">
                        <span>2</span>
                        <p>Enter amount</p>
                    </div>
                    <div class="flow-pill">
                        <span>3</span>
                        <p>Review & confirm</p>
                    </div>
                    <div class="flow-pill">
                        <span>4</span>
                        <p>FPS payment</p>
                    </div>
                </div>

                <div id="flowStep1" class="flow-step space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-[0.4em] text-emerald-200 font-geist">Step 1</p>
                            <h4 class="text-xl text-white font-geist font-semibold">Choose a recipient</h4>
                            <p class="text-sm text-gray-400">The list syncs with your recipients panel—additions show up instantly.</p>
                        </div>
                        <button class="inline-flex items-center gap-2 text-sm text-blue-200 hover:text-white" id="modalAddRecipient">
                            <i data-lucide="user-plus" class="h-4 w-4"></i>
                            Add new recipient
                        </button>
                    </div>
                    <div id="modalRecipientList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    <div class="flex justify-end gap-3">
                        <button class="rounded-xl border border-white/15 bg-white/5 px-6 py-3 text-sm text-gray-200" disabled>Back</button>
                        <button id="toStep2" class="rounded-xl bg-gradient-to-r from-blue-400 to-emerald-400 px-6 py-3 text-sm font-semibold text-white disabled:opacity-40" disabled>Continue →</button>
                    </div>
                </div>

                <div id="flowStep2" class="flow-step space-y-6 hidden">
                    <div>
                        <p class="text-xs uppercase tracking-[0.4em] text-emerald-200 font-geist">Step 2</p>
                        <h4 class="text-xl text-white font-geist font-semibold">Enter amount & see FX instantly</h4>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <label class="text-xs text-gray-400 font-geist">You send (HKD)</label>
                            <input type="number" id="sendAmountInput" class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20" placeholder="1000">
                            <p class="text-xs text-gray-400">Fee: HKD <span id="feePreview">0.00</span> · Guaranteed FX 1 HKD = 7.056 PHPC</p>
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs text-gray-400 font-geist">Recipient gets</label>
                            <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 px-4 py-3">
                                <p class="text-2xl text-white font-bricolage" id="receiveAmountPreview">PHP 0.00</p>
                                <p class="text-xs text-emerald-200">PHPC bridge amount: <span id="phpcPreview">0</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between gap-3">
                        <button class="rounded-xl border border-white/15 bg-white/5 px-6 py-3 text-sm text-gray-200" data-back-step="1">← Back to recipients</button>
                        <button id="toStep3" class="rounded-xl bg-gradient-to-r from-blue-400 to-emerald-400 px-6 py-3 text-sm font-semibold text-white disabled:opacity-40" disabled>Review details →</button>
                    </div>
                </div>

                <div id="flowStep3" class="flow-step space-y-6 hidden">
                    <div>
                        <p class="text-xs uppercase tracking-[0.4em] text-emerald-200 font-geist">Step 3</p>
                        <h4 class="text-xl text-white font-geist font-semibold">Review transfer details</h4>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 text-sm font-geist">
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4 space-y-2">
                            <p class="text-xs text-gray-400">You send</p>
                            <p class="text-white text-lg" id="reviewSend">HKD 0</p>
                            <p class="text-xs text-gray-500">Fee HKD <span id="reviewFee">0</span></p>
                        </div>
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4 space-y-2">
                            <p class="text-xs text-gray-400">Recipient gets</p>
                            <p class="text-white text-lg" id="reviewReceive">PHP 0</p>
                            <p class="text-xs text-gray-500">PHPC bridge: <span id="reviewPHPC">0</span></p>
                        </div>
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4 space-y-2">
                            <p class="text-xs text-gray-400">Recipient</p>
                            <p class="text-white text-lg" id="reviewRecipientName">-</p>
                            <p class="text-xs text-gray-500" id="reviewRecipientBank">-</p>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-4 text-xs text-emerald-200">
                        <p class="font-semibold">Compliance ready</p>
                        <p>HKMA licensed counterparties + FPS traceability. Alerts fire if SLA exceeds 15 minutes.</p>
                    </div>
                    <div class="flex justify-between gap-3">
                        <button class="rounded-xl border border-white/15 bg-white/5 px-6 py-3 text-sm text-gray-200" data-back-step="2">← Edit amount</button>
                        <button id="toStep4" class="rounded-xl bg-gradient-to-r from-blue-400 to-emerald-400 px-6 py-3 text-sm font-semibold text-white">Go to FPS instructions →</button>
                    </div>
                </div>

                <div id="flowStep4" class="flow-step space-y-6 hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase tracking-[0.4em] text-emerald-200 font-geist">Step 4</p>
                            <h4 class="text-xl text-white font-geist font-semibold">Complete FPS payment</h4>
                            <p class="text-sm text-gray-400">Use QR or FPS ID. Countdown auto-resets if you restart.</p>
                        </div>
                        <div class="text-right text-sm">
                            <p class="text-gray-400">Time left</p>
                            <p class="text-white text-xl font-bricolage" id="fpsCountdown">15:00</p>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="space-y-3 text-sm text-gray-300">
                            <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-gray-400">Recipient</p>
                                    <button class="text-xs text-blue-200 hover:text-white" data-copy="recipientName">Copy</button>
                                </div>
                                <p class="text-white text-lg" id="fpsRecipient">-</p>
                                <p class="text-xs text-gray-500" id="fpsBank">-</p>
                            </div>
                            <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-gray-400">FPS ID</p>
                                    <button class="text-xs text-blue-200 hover:text-white" data-copy="fpsId">Copy</button>
                                </div>
                                <p class="text-white text-lg" id="fpsIdValue">165482739</p>
                            </div>
                            <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-gray-400">Payment reference</p>
                                    <button class="text-xs text-blue-200 hover:text-white" data-copy="paymentRef">Copy</button>
                                </div>
                                <p class="text-white text-lg" id="fpsReference">TX0000000000</p>
                            </div>
                            <div class="bg-emerald-500/10 border border-emerald-400/30 rounded-2xl p-4">
                                <p class="text-xs text-emerald-200">Send exactly</p>
                                <p class="text-2xl text-white font-bricolage" id="fpsExactAmount">HKD 0.00</p>
                            </div>
                        </div>
                        <div class="bg-white/90 rounded-2xl p-6 flex flex-col items-center gap-4 text-center text-slate-900">
                            <img src="assets/fps-qr-code.svg" alt="Placeholder FPS QR code" class="w-44 h-44 rounded-2xl border-2 border-slate-200 shadow-lg"/>
                            <p class="text-sm font-semibold">Scan with your FPS mobile app</p>
                            <ol class="text-left text-xs space-y-1 text-gray-600">
                                <li>1. Open bank app → "FPS Transfer"</li>
                                <li>2. Scan QR or enter FPS ID</li>
                                <li>3. Enter amount + reference</li>
                                <li>4. Confirm payment</li>
                            </ol>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3 md:flex-row">
                        <button class="flex-1 rounded-xl border border-white/15 bg-white/5 px-6 py-3 text-sm text-white" id="restartFlowNew">Start over</button>
                        <button class="flex-1 rounded-xl bg-gradient-to-r from-emerald-400 to-blue-400 px-6 py-3 text-sm font-semibold text-white" id="completeFlowNew">I've completed FPS ✓</button>
                    </div>
                </div>

                <!-- Success State -->
                <div id="flowSuccess" class="flow-step hidden space-y-6 text-center">
                    <div class="flex justify-center">
                        <div class="h-24 w-24 rounded-full bg-emerald-500/20 flex items-center justify-center">
                            <i data-lucide="check" class="h-12 w-12 text-emerald-400"></i>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-2xl text-white font-bricolage font-semibold mb-2">Payment Completed!</h4>
                        <p class="text-sm text-gray-400">Your transfer has been successfully processed</p>
                    </div>
                    <div class="space-y-3 text-left">
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                            <p class="text-xs text-gray-400 mb-1">Recipient</p>
                            <p class="text-white font-semibold" id="successRecipient">-</p>
                        </div>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                <p class="text-xs text-gray-400 mb-1">Amount Sent</p>
                                <p class="text-white font-semibold" id="successAmountSent">HKD 0.00</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                <p class="text-xs text-gray-400 mb-1">Amount Received</p>
                                <p class="text-white font-semibold" id="successAmountReceived">PHP 0.00</p>
                            </div>
                        </div>
                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                            <p class="text-xs text-gray-400 mb-1">Transaction ID</p>
                            <p class="text-white font-semibold font-mono text-sm" id="successTransactionId">TX0000000000</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button class="flex-1 rounded-xl bg-gradient-to-r from-blue-400 to-emerald-400 px-6 py-3 text-sm font-semibold text-white" id="newTransferBtn">New Transfer</button>
                        <button class="flex-1 rounded-xl border border-white/15 bg-white/5 px-6 py-3 text-sm text-white hover:bg-white/10" id="closeSuccessBtn">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Recipient Modal -->
    <div id="addRecipientModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="relative w-full max-w-2xl mx-4 rounded-3xl border border-white/10 bg-slate-900/95 p-8 backdrop-blur-xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <button id="closeAddRecipient" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
            <h3 class="text-2xl text-white font-bricolage font-light mb-6">Add New Recipient</h3>
            <form id="recipientForm" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-300 font-geist mb-2">Full Name</label>
                    <input type="text" id="recipientName" required class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20">
                </div>
                <div>
                    <label class="block text-sm text-gray-300 font-geist mb-2">Country</label>
                    <select id="recipientCountry" required class="w-full rounded-xl border border-white/10 bg-white px-4 py-3 text-gray-900 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20">
                        <option value="">Select Country</option>
                        <option value="PH">Philippines</option>
                        <option value="ID">Indonesia</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 font-geist mb-2">Bank Name</label>
                    <select id="recipientBank" required class="w-full rounded-xl border border-white/10 bg-white px-4 py-3 text-gray-900 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20">
                        <option value="">Select Bank</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 font-geist mb-2">Account Number</label>
                    <input type="text" id="recipientAccount" required class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20">
                </div>
                <div>
                    <label class="block text-sm text-gray-300 font-geist mb-2">Email (Optional)</label>
                    <input type="email" id="recipientEmail" class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20">
                </div>
                <div>
                    <label class="block text-sm text-gray-300 font-geist mb-2">Phone Number (Optional)</label>
                    <input type="tel" id="recipientPhone" class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-400/50 focus:outline-none focus:ring-2 focus:ring-blue-400/20">
                </div>
                <button type="submit" class="w-full rounded-xl bg-gradient-to-r from-blue-400 to-emerald-400 px-6 py-3 text-white font-semibold font-geist hover:shadow-lg shadow-blue-900/30 transition">
                    Add Recipient
                </button>
            </form>
        </div>
    </div>

    <!-- Download Receipt Modal -->
    <div id="downloadReceiptModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="relative w-full max-w-3xl mx-4 rounded-3xl border border-white/10 bg-slate-900/95 p-8 backdrop-blur-xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <button id="closeDownloadReceipt" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
            <h3 class="text-2xl text-white font-bricolage font-light mb-6">Transaction History</h3>
            <div id="transactionList" class="space-y-4">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center flex-shrink-0">
                                <span class="text-white font-bold text-sm font-geist">$</span>
                            </div>
                            <div>
                                <p class="text-white font-geist font-semibold">TX20251029001</p>
                                <p class="text-xs text-gray-400 mt-1">Maria Santos · PHP 35,250 · Oct 29, 2025</p>
                            </div>
                        </div>
                        <span class="text-xs text-emerald-200 flex items-center gap-1"><i data-lucide="check-circle-2" class="h-3 w-3"></i>Completed</span>
                    </div>
                    <button onclick="downloadReceipt('TX20251029001')" class="mt-3 w-full rounded-lg bg-gradient-to-r from-blue-400 to-emerald-400 px-4 py-2 text-sm font-semibold text-white hover:shadow-lg shadow-blue-900/30 transition">
                        <i data-lucide="download" class="h-4 w-4 inline mr-2"></i>Download PDF
                    </button>
                </div>
                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center flex-shrink-0">
                                <span class="text-white font-bold text-sm font-geist">$</span>
                            </div>
                            <div>
                                <p class="text-white font-geist font-semibold">TX20251028002</p>
                                <p class="text-xs text-gray-400 mt-1">Somchai Wong · THB 15,925 · Oct 28, 2025</p>
                            </div>
                        </div>
                        <span class="text-xs text-emerald-200 flex items-center gap-1"><i data-lucide="check-circle-2" class="h-3 w-3"></i>Completed</span>
                    </div>
                    <button onclick="downloadReceipt('TX20251028002')" class="mt-3 w-full rounded-lg bg-gradient-to-r from-blue-400 to-emerald-400 px-4 py-2 text-sm font-semibold text-white hover:shadow-lg shadow-blue-900/30 transition">
                        <i data-lucide="download" class="h-4 w-4 inline mr-2"></i>Download PDF
                    </button>
                </div>
                <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center flex-shrink-0">
                                <span class="text-white font-bold text-sm font-geist">$</span>
                            </div>
                            <div>
                                <p class="text-white font-geist font-semibold">TX20251026004</p>
                                <p class="text-xs text-gray-400 mt-1">Li Wei · CNY 1,820 · Oct 26, 2025</p>
                            </div>
                        </div>
                        <span class="text-xs text-emerald-200 flex items-center gap-1"><i data-lucide="check-circle-2" class="h-3 w-3"></i>Completed</span>
                    </div>
                    <button onclick="downloadReceipt('TX20251026004')" class="mt-3 w-full rounded-lg bg-gradient-to-r from-blue-400 to-emerald-400 px-4 py-2 text-sm font-semibold text-white hover:shadow-lg shadow-blue-900/30 transition">
                        <i data-lucide="download" class="h-4 w-4 inline mr-2"></i>Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Old conflicting code removed - using global functions from head instead -->
    <script>
        // Mobile menu toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const mobileNav = document.getElementById('mobileNav');
        mobileToggle?.addEventListener('click', () => {
            const hidden = mobileNav.classList.contains('hidden');
            mobileNav.classList.toggle('hidden');
            mobileNav.classList.toggle('flex', hidden);
            mobileNav.setAttribute('aria-hidden', hidden ? 'false' : 'true');
            mobileToggle.setAttribute('aria-expanded', hidden ? 'true' : 'false');
        });

        const workflowSection = document.getElementById('transferWorkflow');
        const headerTransferBtn = document.getElementById('headerNewTransfer');
        const summaryTransferBtn = document.getElementById('summaryNewTransfer');
        function scrollToWorkflow() {
            workflowSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        headerTransferBtn?.addEventListener('click', scrollToWorkflow);
        summaryTransferBtn?.addEventListener('click', scrollToWorkflow);
        // Attach sign-out event listeners
        const signOutBtn = document.getElementById('signOutBtn');
        const mobileSignOutBtn = document.getElementById('mobileSignOutBtn');
        if (signOutBtn) signOutBtn.addEventListener('click', window.signOut);
        if (mobileSignOutBtn) mobileSignOutBtn.addEventListener('click', window.signOut);
    </script>
    
    <!-- Fallback initialization script -->
    <script>
        function mapAuthError(e) {
            const msg = (e?.message || '').toLowerCase();
            if (msg.includes('network')) return '網絡錯誤，請稍後重試';
            if (msg.includes('access_denied') || msg.includes('consent')) return '已取消授權或拒絕訪問';
            if (msg.includes('redirect_uri')) return '重定向地址不正確，請檢查配置';
            if (msg.includes('invalid_client')) return '客戶端配置錯誤，請檢查 Client ID/Secret';
            return '登入失敗，請重試';
        }
        function testExtract() {
            const cases = [
                { user_metadata: { name: 'Jane Doe' } },
                { user_metadata: { full_name: 'Juan Dela Cruz' } },
                { email: 'maria@example.com' }
            ];
            const results = cases.map(c => extractName(c));
            console.assert(results[0] === 'Jane Doe', 'name fail');
            console.assert(results[1] === 'Juan Dela Cruz', 'full_name fail');
            console.assert(results[2] === 'maria', 'email fail');
        }
        function testErrors() {
            const e1 = { message: 'network error' };
            const e2 = { message: 'redirect_uri mismatch' };
            const e3 = { message: 'access_denied' };
            console.assert(mapAuthError(e1) === '網絡錯誤，請稍後重試', 'net');
            console.assert(mapAuthError(e2) === '重定向地址不正確，請檢查配置', 'redir');
            console.assert(mapAuthError(e3) === '已取消授權或拒絕訪問', 'consent');
        }
        async function testSession() {
            const s = await getSessionSafe();
            console.assert(!!s, 'session missing');
        }
        async function runAuthTests() {
            await testSession();
            testExtract();
            testErrors();
            console.log('Auth tests passed');
        }
    </script>
    
    <!-- Fallback initialization script -->
    <script>
        // Flow step navigation
        window.showFlowStep = function(index) {
            const flowSteps = ['flowStep1','flowStep2','flowStep3','flowStep4'].map(id => document.getElementById(id));
            const flowPills = Array.from(document.querySelectorAll('#sendFlowProgress .flow-pill'));
            
            flowSteps.forEach((step, i) => {
                if (!step) return;
                if (i === index) step.classList.remove('hidden');
                else step.classList.add('hidden');
            });
            
            flowPills.forEach((pill, i) => {
                pill.classList.toggle('active', i === index);
                pill.classList.toggle('completed', i < index);
            });
            
            if (index !== 3) {
                window.resetCountdown();
            }
        };
        
        window.resetCountdown = function() {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
            const fpsCountdown = document.getElementById('fpsCountdown');
            if (fpsCountdown) fpsCountdown.textContent = '15:00';
        };
        
        window.startCountdown = function() {
            window.resetCountdown();
            let remaining = 15 * 60;
            window.countdownInterval = setInterval(() => {
                remaining -= 1;
                if (remaining <= 0) {
                    window.resetCountdown();
                    return;
                }
                const minutes = String(Math.floor(remaining / 60)).padStart(2, '0');
                const seconds = String(remaining % 60).padStart(2, '0');
                const fpsCountdown = document.getElementById('fpsCountdown');
                if (fpsCountdown) fpsCountdown.textContent = `${minutes}:${seconds}`;
            }, 1000);
        };
        
        window.resetSendMoneyFlow = function() {
            window.selectedRecipientId = null;
            window.currentAmount = 0;
            const sendAmountInput = document.getElementById('sendAmountInput');
            if (sendAmountInput) sendAmountInput.value = '';
            
            const feePreview = document.getElementById('feePreview');
            const receiveAmountPreview = document.getElementById('receiveAmountPreview');
            const reviewSend = document.getElementById('reviewSend');
            const reviewFee = document.getElementById('reviewFee');
            const reviewReceive = document.getElementById('reviewReceive');
            const reviewRecipientName = document.getElementById('reviewRecipientName');
            const reviewRecipientBank = document.getElementById('reviewRecipientBank');
            const fpsRecipient = document.getElementById('fpsRecipient');
            const fpsBank = document.getElementById('fpsBank');
            const fpsReference = document.getElementById('fpsReference');
            const fpsExactAmount = document.getElementById('fpsExactAmount');
            
            if (feePreview) feePreview.textContent = '0.00';
            if (receiveAmountPreview) receiveAmountPreview.textContent = 'PHP 0.00';
            if (reviewSend) reviewSend.textContent = 'HKD 0';
            if (reviewFee) reviewFee.textContent = '0';
            if (reviewReceive) reviewReceive.textContent = 'PHP 0';
            if (reviewRecipientName) reviewRecipientName.textContent = '-';
            if (reviewRecipientBank) reviewRecipientBank.textContent = '-';
            if (fpsRecipient) fpsRecipient.textContent = '-';
            if (fpsBank) fpsBank.textContent = '-';
            if (fpsReference) fpsReference.textContent = 'TX0000000000';
            if (fpsExactAmount) fpsExactAmount.textContent = 'HKD 0.00';
            
            window.renderModalRecipients();
            window.showFlowStep(0);
            window.updateStepControls();
        };
        
        window.populateReviewRecipient = function() {
            const recipient = window.getSelectedRecipient();
            if (!recipient) return;
            const reviewRecipientName = document.getElementById('reviewRecipientName');
            const reviewRecipientBank = document.getElementById('reviewRecipientBank');
            if (reviewRecipientName) reviewRecipientName.textContent = recipient.name;
            if (reviewRecipientBank) reviewRecipientBank.textContent = `${recipient.bank} • ${window.maskAccount(recipient.account)}`;
        };
        
        window.populateFpsSection = function() {
            const recipient = window.getSelectedRecipient();
            if (!recipient) return;
            const php = (window.currentAmount * 6.5).toFixed(2);
            const txId = `TX${Date.now()}`;
            
            const fpsRecipient = document.getElementById('fpsRecipient');
            const fpsBank = document.getElementById('fpsBank');
            const fpsReference = document.getElementById('fpsReference');
            const fpsExactAmount = document.getElementById('fpsExactAmount');
            const feePreview = document.getElementById('feePreview');
            
            if (fpsRecipient) fpsRecipient.textContent = recipient.name;
            if (fpsBank) fpsBank.textContent = `${recipient.bank} (${window.countryLabels[recipient.country] || recipient.country})`;
            if (fpsReference) fpsReference.textContent = txId;
            if (fpsExactAmount) fpsExactAmount.textContent = `HKD ${(window.currentAmount + parseFloat(feePreview?.textContent || '0')).toFixed(2)}`;
            
            const fpsFinalPhp = document.getElementById('fpsFinalPhp');
            if (fpsFinalPhp) fpsFinalPhp.textContent = `PHP ${php}`;
        };
        
        // Ensure icons are rendered and functions are accessible
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Attach event listeners for buttons if module script failed
        const sendMoneyBtn = document.getElementById('sendMoneyBtn');
        const sendMoneyModal = document.getElementById('sendMoneyModal');
        const closeSendMoney = document.getElementById('closeSendMoney');
        const toStep2 = document.getElementById('toStep2');
        const toStep3 = document.getElementById('toStep3');
        const toStep4 = document.getElementById('toStep4');
        const sendAmountInput = document.getElementById('sendAmountInput');
        const backStepButtons = document.querySelectorAll('[data-back-step]');
        const modalAddRecipient = document.getElementById('modalAddRecipient');
        
        // Send Money Modal open/close
        if (sendMoneyBtn && sendMoneyModal) {
            sendMoneyBtn.addEventListener('click', () => {
                window.resetSendMoneyFlow();
                sendMoneyModal.classList.remove('hidden');
                sendMoneyModal.classList.add('flex');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }
        
        if (closeSendMoney && sendMoneyModal) {
            closeSendMoney.addEventListener('click', () => {
                window.resetSendMoneyFlow();
                sendMoneyModal.classList.add('hidden');
                sendMoneyModal.classList.remove('flex');
            });
        }
        
        if (sendMoneyModal) {
            sendMoneyModal.addEventListener('click', (event) => {
                if (event.target === sendMoneyModal) {
                    window.resetSendMoneyFlow();
                    sendMoneyModal.classList.add('hidden');
                    sendMoneyModal.classList.remove('flex');
                }
            });
        }
        
        // Step navigation
        if (toStep2) {
            toStep2.addEventListener('click', () => {
                if (!window.selectedRecipientId) return;
                window.showFlowStep(1);
                if (sendAmountInput) sendAmountInput.focus();
            });
        }
        
        if (toStep3) {
            toStep3.addEventListener('click', () => {
                if (!window.currentAmount) return;
                window.updateAmountPreviews();
                window.populateReviewRecipient();
                window.showFlowStep(2);
            });
        }
        
        if (toStep4) {
            toStep4.addEventListener('click', () => {
                window.populateFpsSection();
                window.showFlowStep(3);
                window.startCountdown();
            });
        }
        
        // Back buttons
        backStepButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = parseInt(btn.getAttribute('data-back-step'), 10);
                if (Number.isInteger(target)) window.showFlowStep(target - 1);
            });
        });
        
        // Amount input
        if (sendAmountInput) {
            sendAmountInput.addEventListener('input', window.updateAmountPreviews);
        }
        
        // Add recipient button
        if (modalAddRecipient) {
            modalAddRecipient.addEventListener('click', () => {
                const name = prompt('Recipient name:');
                if (!name) return;
                const country = prompt('Country code (PH/TH/ID/VN):');
                if (!country) return;
                const bank = prompt('Bank name:');
                if (!bank) return;
                const account = prompt('Account number:');
                if (!account) return;
                
                window.addNewRecipient(name, country, bank, account);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
        
        // Initial render
        window.renderModalRecipients();
        
        // Attach event listeners for Add Recipient modal
        const addRecipientBtn = document.getElementById('addRecipientBtn');
        const addRecipientModal = document.getElementById('addRecipientModal');
        const closeAddRecipient = document.getElementById('closeAddRecipient');
        
        if (addRecipientBtn && addRecipientModal) {
            addRecipientBtn.addEventListener('click', () => {
                addRecipientModal.classList.remove('hidden');
                addRecipientModal.classList.add('flex');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }
        
        if (closeAddRecipient && addRecipientModal) {
            closeAddRecipient.addEventListener('click', () => {
                addRecipientModal.classList.add('hidden');
                addRecipientModal.classList.remove('flex');
            });
        }
        
        if (addRecipientModal) {
            addRecipientModal.addEventListener('click', (e) => {
                if (e.target === addRecipientModal) {
                    addRecipientModal.classList.add('hidden');
                    addRecipientModal.classList.remove('flex');
                }
            });
        }
        
        // Bank options by country
        const banksByCountry = {
            'PH': [
                { code: '011', name: 'BDO Unibank, Inc. (Bank Code: 011)' },
                { code: '018', name: 'Metropolitan Bank & Trust Company (Metrobank) (Bank Code: 018)' },
                { code: '010', name: 'Bank of the Philippine Islands (BPI) (Bank Code: 010)' }
            ],
            'ID': [
                { code: '008', name: 'PT Bank Mandiri (Persero) Tbk (Bank Code: 008)' },
                { code: '002', name: 'PT Bank Rakyat Indonesia (Persero) Tbk (Bank Code: 002)' },
                { code: '014', name: 'PT Bank Central Asia Tbk (Bank Code: 014)' }
            ]
        };
        
        // Handle country selection change
        const recipientCountry = document.getElementById('recipientCountry');
        const recipientBank = document.getElementById('recipientBank');
        const recipientAccount = document.getElementById('recipientAccount');
        
        if (recipientCountry) {
            recipientCountry.addEventListener('change', (e) => {
                const selectedCountry = e.target.value;
                
                // Clear bank dropdown
                if (recipientBank) {
                    recipientBank.innerHTML = '<option value="">Select Bank</option>';
                    
                    // Populate banks based on selected country
                    if (selectedCountry && banksByCountry[selectedCountry]) {
                        banksByCountry[selectedCountry].forEach(bank => {
                            const option = document.createElement('option');
                            option.value = bank.code;
                            option.textContent = bank.name;
                            recipientBank.appendChild(option);
                        });
                    }
                }
                
                // Clear account number when country changes
                if (recipientAccount) {
                    recipientAccount.value = '';
                }
            });
        }
        
        // Account number validation (BDO, Metrobank, BPI, Bank Mandiri, BRI, BCA)
        if (recipientAccount) {
            recipientAccount.addEventListener('blur', (e) => {
                const country = recipientCountry?.value;
                const bank = recipientBank?.value;
                const accountValue = e.target.value.trim();
                
                // BDO validation (Philippines + BDO)
                if (country === 'PH' && bank === '011' && accountValue) {
                    const accountLength = accountValue.length;
                    
                    // Check if account contains only digits
                    if (!/^\d+$/.test(accountValue)) {
                        alert('Invalid BDO Unibank account format. Please enter a 12-digit numeric account number.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Handle 10-digit legacy accounts
                    if (accountLength === 10) {
                        const confirmed = confirm('BDO legacy account detected. Please prepend two zeros at the beginning to make it 12 digits.');
                        if (confirmed) {
                            e.target.value = '00' + accountValue;
                        } else {
                            e.target.value = '';
                        }
                    } else if (accountLength !== 12) {
                        // Invalid length
                        alert('Invalid BDO Unibank account format. Please enter a 12-digit numeric account number.');
                        e.target.value = '';
                    }
                }
                
                // Metrobank validation (Philippines + Metrobank)
                if (country === 'PH' && bank === '018' && accountValue) {
                    const accountLength = accountValue.length;
                    
                    // Check if account contains only digits
                    if (!/^\d+$/.test(accountValue)) {
                        alert('Invalid Metropolitan Bank & Trust Company account format. Please enter a 13-digit numeric account number.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check for exactly 13 digits (excludes Virtual Accounts)
                    if (accountLength !== 13) {
                        alert('Invalid Metropolitan Bank & Trust Company account format. Please enter a 13-digit numeric account number.');
                        e.target.value = '';
                    }
                }
                
                // BPI validation (Philippines + BPI)
                if (country === 'PH' && bank === '010' && accountValue) {
                    const accountLength = accountValue.length;
                    
                    // Check if account contains only digits
                    if (!/^\d+$/.test(accountValue)) {
                        alert('Invalid Bank of the Philippine Islands account format. Please enter a 10-digit numeric account number.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check for exactly 10 digits (excludes Virtual Accounts)
                    if (accountLength !== 10) {
                        alert('Invalid Bank of the Philippine Islands account format. Please enter a 10-digit numeric account number.');
                        e.target.value = '';
                    }
                }
                
                // Bank Mandiri validation (Indonesia + Bank Mandiri)
                if (country === 'ID' && bank === '008' && accountValue) {
                    const accountLength = accountValue.length;
                    
                    // Check if account contains only digits
                    if (!/^\d+$/.test(accountValue)) {
                        alert('Invalid PT Bank Mandiri (Persero) Tbk account format. Please enter a 13-digit numeric account number.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Check for exactly 13 digits
                    if (accountLength !== 13) {
                        alert('Invalid PT Bank Mandiri (Persero) Tbk account format. Please enter a 13-digit numeric account number.');
                        e.target.value = '';
                    }
                }
                
                // BRI validation (Indonesia + BRI)
                if (country === 'ID' && bank === '002' && accountValue) {
                    const accountLength = accountValue.length;
                    
                    // Check if account contains only digits
                    if (!/^\d+$/.test(accountValue)) {
                        alert('Invalid PT Bank Rakyat Indonesia (Persero) Tbk account format. Please enter a 15-digit numeric account number.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Reject if not exactly 15 digits (excludes Virtual Accounts)
                    if (accountLength !== 15) {
                        alert('Invalid PT Bank Rakyat Indonesia (Persero) Tbk account format. Please enter a 15-digit numeric account number.');
                        e.target.value = '';
                    }
                }
                
                // BCA validation (Indonesia + BCA)
                if (country === 'ID' && bank === '014' && accountValue) {
                    const accountLength = accountValue.length;
                    
                    // Check if account contains only digits
                    if (!/^\d+$/.test(accountValue)) {
                        alert('Invalid PT Bank Central Asia Tbk account format. Please enter a 10-digit numeric account number.');
                        e.target.value = '';
                        return;
                    }
                    
                    // Reject if not exactly 10 digits (excludes Virtual Accounts)
                    if (accountLength !== 10) {
                        alert('Invalid PT Bank Central Asia Tbk account format. Please enter a 10-digit numeric account number.');
                        e.target.value = '';
                    }
                }
            });
        }
        
        // Attach event listener for Add Recipient form submission
        const recipientForm = document.getElementById('recipientForm');
        if (recipientForm) {
            recipientForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('recipientName').value.trim();
                const country = document.getElementById('recipientCountry').value;
                const bankCode = document.getElementById('recipientBank').value.trim();
                const bankSelect = document.getElementById('recipientBank');
                const bankName = bankSelect?.options[bankSelect.selectedIndex]?.text || bankCode;
                const account = document.getElementById('recipientAccount').value.trim();

                if (!name || !country || !bankCode || !account) {
                    alert('Please fill in all required fields.');
                    return;
                }

                const accentOptions = ['blue', 'emerald', 'purple', 'amber'];
                const accent = accentOptions[window.recipients.length % accentOptions.length];
                const newRecipient = {
                    id: `rcp-${Date.now()}`,
                    name,
                    country,
                    bank: bankName,
                    account,
                    avatar: name.charAt(0).toUpperCase(),
                    accent
                };

                window.recipients.push(newRecipient);
                recipientForm.reset();
                addRecipientModal.classList.add('hidden');
                addRecipientModal.classList.remove('flex');
                window.renderModalRecipients();
                window.selectRecipient(newRecipient.id);
                alert('Recipient added and ready for transfers!');
            });
        }
        
        // Attach event listeners for FPS flow buttons
        const restartFlowNew = document.getElementById('restartFlowNew');
        const completeFlowNew = document.getElementById('completeFlowNew');
        
        if (restartFlowNew) {
            restartFlowNew.addEventListener('click', () => {
                window.resetSendMoneyFlow();
                window.showFlowStep(0);
            });
        }
        
        if (completeFlowNew) {
            completeFlowNew.addEventListener('click', () => {
                const recipient = window.getSelectedRecipient();
                if (!recipient || !window.currentAmount) {
                    alert('Select a recipient and amount before completing the flow.');
                    return;
                }
                const php = (window.currentAmount * 6.5).toFixed(2);
                const txId = `TX${Date.now()}`;
                
                // Update success state with transaction details
                document.getElementById('successRecipient').textContent = recipient.name;
                document.getElementById('successAmountSent').textContent = `HKD ${window.currentAmount.toFixed(2)}`;
                document.getElementById('successAmountReceived').textContent = `PHP ${php}`;
                document.getElementById('successTransactionId').textContent = txId;
                
                // Hide all flow steps and show success state
                document.querySelectorAll('.flow-step').forEach(step => {
                    step.classList.add('hidden');
                });
                document.getElementById('flowSuccess').classList.remove('hidden');
                
                // Hide the flow progress pills
                document.getElementById('sendFlowProgress').classList.add('hidden');
                
                // Recreate icons for the new checkmark
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }
        
        // Attach event listeners for success state buttons
        const newTransferBtn = document.getElementById('newTransferBtn');
        const closeSuccessBtn = document.getElementById('closeSuccessBtn');
        
        if (newTransferBtn) {
            newTransferBtn.addEventListener('click', () => {
                // Reset and show flow step 1
                document.getElementById('flowSuccess').classList.add('hidden');
                document.getElementById('sendFlowProgress').classList.remove('hidden');
                window.resetSendMoneyFlow();
                window.showFlowStep(0);
            });
        }
        
        if (closeSuccessBtn) {
            closeSuccessBtn.addEventListener('click', () => {
                const sendMoneyModal = document.getElementById('sendMoneyModal');
                if (sendMoneyModal) {
                    document.getElementById('flowSuccess').classList.add('hidden');
                    document.getElementById('sendFlowProgress').classList.remove('hidden');
                    window.resetSendMoneyFlow();
                    sendMoneyModal.classList.add('hidden');
                    sendMoneyModal.classList.remove('flex');
                }
            });
        }
        
        // Attach event listeners for Download Receipt modal
        const downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
        const downloadReceiptModal = document.getElementById('downloadReceiptModal');
        const closeDownloadReceipt = document.getElementById('closeDownloadReceipt');
        
        if (downloadReceiptBtn && downloadReceiptModal) {
            downloadReceiptBtn.addEventListener('click', () => {
                downloadReceiptModal.classList.remove('hidden');
                downloadReceiptModal.classList.add('flex');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }
        
        if (closeDownloadReceipt && downloadReceiptModal) {
            closeDownloadReceipt.addEventListener('click', () => {
                downloadReceiptModal.classList.add('hidden');
                downloadReceiptModal.classList.remove('flex');
            });
        }
        
        if (downloadReceiptModal) {
            downloadReceiptModal.addEventListener('click', (e) => {
                if (e.target === downloadReceiptModal) {
                    downloadReceiptModal.classList.add('hidden');
                    downloadReceiptModal.classList.remove('flex');
                }
            });
        }
        
        // Make downloadReceipt globally accessible as fallback
        if (typeof window.downloadReceipt === 'undefined') {
            window.downloadReceipt = function(txId) {
                const receiptContent = `
                    FPS-Stable Transaction Receipt
                    ==============================
                    
                    Transaction ID: ${txId}
                    Date: ${new Date().toLocaleDateString()}
                    Status: Completed
                    
                    This is a demo receipt for transaction ${txId}.
                    In a production environment, this would generate
                    a proper PDF file with all transaction details.
                `;
                
                const blob = new Blob([receiptContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${txId}_receipt.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`Receipt for ${txId} downloaded successfully!`);
            };
        }
    </script>
</body>
</html>

